#IMPORT LIBRARIES
import pandas as pd
import streamlit as st
from streamlit_lottie import st_lottie
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import requests
import plotly.express as px


#WEB PAGE CONFIGURATION
st.set_page_config(page_title ="My Webpage")  # you can add the argument layout = "wide"


#INTRODUCE PROJECT COLLABORATORS
from PIL import Image
with st.expander("Click to view project members and the goal of this project"):
    col1, col2, col3 = st.columns(3)
    with col1:
        #st.markdown(f'<p style="background-color:#0066cc;color:#33ff33;font-size:24px;border-radius:2%;">'great'</p>', unsafe_allow_html=True)
        st.write("Senior Engineer (Nazanin)")
        image = Image.open(r'C:\Users\Nana\nazanin.jpg')
        st.image(image, use_column_width=True)

    with col2:
        st.write("Technical Lead (Ernest)")
        image = Image.open(r'C:\Users\Nana\ernest.jpg')
        st.image(image,use_column_width=True )
        

    with col3:
        st.write("Team Engineer (Rima)")
        image = Image.open(r'C:\Users\Nana\Reema.jpg')
        st.image(image, use_column_width=True)
        
    
    st.write("""
        This project is an initiative of the Data-Cirle of the Redi School of Digital Integration.
        The project deploys a fully interactive web analytics app using the
        streamlit library and other python dependencies.
        The goal is to improve the competence of the team members in designing
        fully functional interactive web base applications
     """)
    
     
        


#USE REQUESTS TO PULL ANIMATION FROM LOTTIE WEBSITE
@st.experimental_memo
def load_lottieurl(url):
    r =requests.get(url)
    if r.status_code != 200:
        return None
    return r.json()
lottie = load_lottieurl("https://assets4.lottiefiles.com/private_files/lf30_1KyL2Q.json")
st_lottie(lottie, height =100, key ="covid")


#INSERT COVID PICTURES
from PIL import Image
with st.container():
    # Create headers
    st.markdown("<h1 style='text-align: center; color: green;'>COVID-19 Live Interactive Dashboard</h1>", unsafe_allow_html=True)
    left_col, right_col = st.columns(2)
    with left_col:
         image = Image.open(r'C:\Users\Nana\analytics.jpg')  # Put r in front of the file directory to be able to call the picture.
         st.image(image, width = 320)
    with right_col:
         image = Image.open(r'C:\Users\Nana\update.jpg')
         st.image(image, width = 300)
st.write("This analytics app provides real time updates on Covid-19 incidence around the world with Streamlit")
        
#DATA EXTRACTION 
with st.container():
    st.write("---")
    df = pd.read_csv("https://covid.ourworldindata.org/data/owid-covid-data.csv")
    #df.dropna(axis =0, how='any', thresh=None, subset=None, inplace=True)
    
    
# PREPROCESSING:
cols_to_keep = ['iso_code','continent', 'location', 'date','total_deaths', 'total_cases', 'total_tests', 'total_vaccinations']
df = df[cols_to_keep]
df['date'] = pd.to_datetime(df['date'], format="%Y-%m-%d")  # Convert date which is a  string to datetime format
df['date1'] = df['date'].dt.strftime("%Y-%M")  # Converts to a year month only format
ger = df[(df['location'] == 'Germany')]
check = st.checkbox("Check to display raw data")
if check:
    data_load_state = st.text('Loading data...')
    st.dataframe(df)
    data_load_state.text('Loading data...done!')


@st.experimental_memo
def convert_df(df):
     # IMPORTANT: Cache the conversion to prevent computation on every rerun
     return df.to_csv().encode('utf-8')
csv = convert_df(df)
st.download_button(
     label="Download data as CSV",
     data=csv,
     file_name='Covid.csv',
     mime='text/csv',
 )
# CREATE RELEVANT GROUPBY'S FOR THE DATA  ANALYSIS
t_death = df.groupby(["continent","iso_code",'date1','location'])["total_deaths"].mean().sort_values(ascending = False).reset_index()  #Total deaths
t_case = df.groupby(["continent","iso_code",'date1','location'])["total_cases"].mean().sort_values(ascending = False).reset_index()  #Total cases
t_test = df.groupby(["continent","iso_code",'date1','location'])["total_tests"].mean().sort_values(ascending = False).reset_index() # total_tests
t_vac = df.groupby(["continent","iso_code",'date1','location'])["total_vaccinations"].mean().sort_values(ascending = False).reset_index() 
t_case1 = t_case[t_case['total_cases'].notna()]  # select observations which are not missing into a new dataframe

#CREATE WIDGETS FOR THE APP
# Drop down list for our countries
st.sidebar.header("Visualisation settings")    
country_box = st.sidebar.selectbox(
    "Select a country",
    ("Germany", "Ghana", "USA")
)
# Visualization Selector 
visual_box = st.sidebar.selectbox(
    "What type of visualization do you want to view?",
    ("Spatial visualizations", "Barplots", "Line Charts", "Radar Charts")
)

if country_box == "Germany" and visual_box == "Line Charts":
     fig = px.line(ger, x="date", y="total_tests", title = "Test Trend for Germany")  #  Line chart
     st.plotly_chart(fig, use_column_width=True)
    
elif country_box == "USA" and visual_box == "Radar Charts":
    st.write("Radar Chart for the United States")
    dff = pd.DataFrame(dict(
    r=[79000000, 14000000,  50000000, 33000000 ],
    theta=['Total deaths','ICU patients','Total vaccinations',
           'Total hospitalizations']))
    fig = px.line_polar(dff, r='r', theta='theta', line_close=True)
    fig.update_traces(fill='toself')
    st.plotly_chart(fig, use_column_width=True)

#VISUALIZATIONS  (Barplots)
# Define a barplot function:
with st.container():
    left_col, right_col = st.columns(2)
    with left_col:
        st.markdown("<h1 style='text-align: right; color: blue;'>Barplots</h1>", unsafe_allow_html=True)        
    with right_col:
        lottie = load_lottieurl("https://assets5.lottiefiles.com/packages/lf20_2p5ywtpt.json")
        st_lottie(lottie, height =150, key ="bar")

with st.expander("ClICK TO VIEW TOTAL DEATHS BY CONTINENT & COUNTRY"):
    with st.container():
        @st.experimental_memo(suppress_st_warning=True)
        def barplot(data,y,x,color, title):
            fig = px.bar(data, y, x, color, title =title)
            #return st.plotly_chart(fig)
            st.plotly_chart(fig)
        barplot(t_death, t_death["total_deaths"], t_death["continent"], t_death['iso_code'], "Total Deaths by Country")
            
with st.expander("ClICK TO VIEW TOTAL CASES BY CONTINENT & COUNTRY"):
    with st.container():
        barplot(t_case, t_case["total_cases"], t_case["continent"], t_case['iso_code'], "Total cases by country and continent")
                   
with st.expander("ClICK TO VIEW TOTAL TESTS BY CONTINENT & COUNTRY"):           
    with st.container():
         barplot(t_test, t_test["total_tests"], t_test["continent"], t_test['iso_code'], "Total tests by country and continent")
                   
with st.expander("ClICK TO VIEW TOTAL VACCINATIONS BY CONTINENT & COUNTRY"):           
    with st.container():
        barplot(t_vac, t_vac["total_vaccinations"], t_vac["continent"], t_vac['iso_code'], "Total vaccinations by country and continent" 

#VISUALIZATIONS  (Geospatial)
with st.container():
    left_col, right_col = st.columns(2)
    with left_col:
        st.markdown("<h1 style='text-align: right; color: blue;'>Geo-Analysis</h1>", unsafe_allow_html=True)        
    with right_col:
        lottie = load_lottieurl("https://assets7.lottiefiles.com/packages/lf20_B6txqj.json")
        st_lottie(lottie, height =100, key ="globe")
        
st.write("---")        
map = st.radio(
     "CLICK TO CHANGE TO A DIFFERENT MAP",
     ('Map of Total deaths', 'Map of Total Cases', 'Map of Total Tests', 'Map of Total Vaccinations'))


@st.experimental_memo(suppress_st_warning=True)
def map(data,loc,color,pro,scope, title):
         fig = px.choropleth(data,loc,color,pro,scope,title=title)
         st.plotly_chart(fig,use_column_width=True)
            
if map == 'Map of Total deaths':
    map(t_death, t_death["iso_code"], t_death['total_deaths'], pro ="cylindrical stereographic", scope ="world", title ="Total Deaths by Country")
  
   
elif map == 'Map of Total Vaccinations':
    map(t_vac, t_vac["iso_code"], t_vac['total_vaccinations'],pro ="cylindrical stereographic",  scope ="world",title= "Total Vaccinations") 
                
elif map == 'Map of Total Tests':
    map(t_test, t_test["iso_code"], t_test['total_tests'],pro ="natural earth", scope ="world",title ="Total Tests") 
                                
elif map == 'Map of Total Cases':
    @st.experimental_memo(suppress_st_warning=True)
    def hov(data,loc,color,hov,size,pro):
         fig = px.scatter_geo(data,loc,color,hov,size,pro)
         st.plotly_chart(fig,use_column_width=True)
   hov(t_case1, t_case1["iso_code"], t_case1['continent'], t_case1['location'],t_case1['total_cases'], pro ="natural earth" )   


               
#LINE GRAPHS  ()
st.write("---") 
with st.container():
    left_col, right_col = st.columns(2)
    with left_col:
        st.markdown("<h1 style='text-align: right; color: blue;'>TRENDS</h1>", unsafe_allow_html=True)        
    with right_col:
        lottie = load_lottieurl("https://assets5.lottiefiles.com/packages/lf20_iqfq0ogz.json")
        st_lottie(lottie, height =100, key ="trends")
        
with st.container():
    fig = px.line(df, x="date", y="total_deaths", color='location', title = "Death Trend")
    st.plotly_chart(fig, use_column_width=False)
            
with st.container():
    fig = px.line(df, x="date", y="total_vaccinations", color='location', title = "Vaccination Trend")
             #fig.update_layout(paper_bgcolor="black")
    st.plotly_chart(fig, use_column_width=True)
            
with st.container():
     fig = px.line(df, x="date", y="total_cases", color='location', title = "Cases Trend")
     st.plotly_chart(fig, use_column_width=False)
            
with st.container():
     fig = px.line(df, x="date", y="total_tests", color='location', title = "Test Trend")
     st.plotly_chart(fig, use_column_width=False)
 
